{{define "styles"}}
.photo-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #000; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.capture-prompt {
  text-align: center; color: #fff; padding: 24px;
}
.capture-prompt p {
  font-size: 1.1rem; margin-bottom: 32px; opacity: 0.8;
}
.capture-label {
  display: inline-flex; align-items: center; justify-content: center;
  width: 72px; height: 72px; border-radius: 50%;
  border: 4px solid #fff; background: rgba(255,255,255,0.3);
  cursor: pointer; transition: background 0.2s;
}
.capture-label:active { background: rgba(255,255,255,0.6); }
.capture-label svg { width: 32px; height: 32px; fill: #fff; }
.capture-input { display: none; }
.preview-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #000; display: none; flex-direction: column;
}
.preview-container.active { display: flex; }
.preview-container img {
  flex: 1; width: 100%; object-fit: contain;
}
.preview-controls {
  position: absolute; bottom: 0; left: 0; right: 0;
  padding: 24px; display: flex; justify-content: space-around;
  background: linear-gradient(transparent, rgba(0,0,0,0.6));
}
.preview-btn {
  padding: 14px 32px; border-radius: 8px; border: none;
  font-size: 1rem; font-weight: 500; cursor: pointer;
}
.btn-retake { background: rgba(255,255,255,0.2); color: #fff; }
.btn-submit { background: #fff; color: #111; }
.spinner-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); display: none;
  align-items: center; justify-content: center; z-index: 100;
}
.spinner-overlay.active { display: flex; }
.spinner {
  width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.3);
  border-top-color: #fff; border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
{{end}}

{{define "content"}}
<!-- Capture prompt -->
<div class="photo-container" id="captureView">
  <div class="capture-prompt">
    <p>Tap to open camera</p>
    <label class="capture-label" for="cameraInput">
      <svg viewBox="0 0 24 24"><path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2 7.17 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-3.17L15 2H9zm3 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
    </label>
    <input type="file" id="cameraInput" class="capture-input" accept="image/*" capture="environment">
  </div>
</div>

<!-- Photo preview -->
<div class="preview-container" id="previewView">
  <img id="previewImg" alt="Captured photo">
  <div class="preview-controls">
    <button class="preview-btn btn-retake" onclick="retakePhoto()">Retake</button>
    <button class="preview-btn btn-submit" id="submitBtn" onclick="submitPhoto()">Submit</button>
  </div>
</div>

<!-- Loading spinner -->
<div class="spinner-overlay" id="spinnerView">
  <div class="spinner"></div>
</div>
{{end}}

{{define "scripts"}}
<script>
const cameraInput = document.getElementById('cameraInput');
const previewImg = document.getElementById('previewImg');
const captureView = document.getElementById('captureView');
const previewView = document.getElementById('previewView');
const spinnerView = document.getElementById('spinnerView');

const sessionID = '{{.SessionID}}';
const submitURL = '{{.SubmitURL}}';
const outputFormat = '{{.OutputFormat}}';

let capturedFile = null;

cameraInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  capturedFile = file;
  previewImg.src = URL.createObjectURL(file);
  captureView.style.display = 'none';
  previewView.classList.add('active');
});

function retakePhoto() {
  if (previewImg.src.startsWith('blob:')) {
    URL.revokeObjectURL(previewImg.src);
  }
  capturedFile = null;
  cameraInput.value = '';
  previewView.classList.remove('active');
  captureView.style.display = 'flex';
}

async function submitPhoto() {
  if (!capturedFile) return;

  spinnerView.classList.add('active');
  document.getElementById('submitBtn').disabled = true;

  try {
    const arrayBuffer = await capturedFile.arrayBuffer();
    const base64Data = btoa(
      new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), '')
    );

    const mimeType = capturedFile.type || 'image/jpeg';
    const ext = mimeType === 'image/png' ? 'png' : 'jpg';

    const payload = {
      items: [{
        content_type: mimeType,
        filename: 'photo.' + ext,
        data: base64Data
      }]
    };

    const response = await fetch(submitURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      window.location.href = '/s/' + sessionID;
    } else {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || 'Upload failed');
    }
  } catch (err) {
    spinnerView.classList.remove('active');
    document.getElementById('submitBtn').disabled = false;
    alert('Failed to submit photo: ' + err.message);
  }
}
</script>
{{end}}
